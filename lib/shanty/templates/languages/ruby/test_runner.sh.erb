#!/bin/bash --login

export RAILS_ENV=test
export PROJECT_DIR="/vagrant/project"
export CI_REPORTS="/vagrant/reports"

# ssh -oStrictHostKeyChecking=no github.com
mkdir $PROJECT_DIR
cd $PROJECT_DIR 
tar xf ../project.tar

# before_install
<% if !@project_config.before_install.empty? %>
  <% @project_config.before_install.each do |test_step| %>
    echo "Running before_install step '<%= test_step %>'"
    <%= test_step %>
  <% end %>
<% end %>

if ! grep -q ci_reporter Gemfile; then
  echo "gem 'ci_reporter'" >> Gemfile
fi

<% if !@project_config.rbenv.empty? %>
  <% @project_config.rbenv.each do |ruby_version| %>
    # switch to the current ruby version
    cd $PROJECT_DIR
    echo "Switching to ruby <%= ruby_version -%>"
    rbenv local <%= ruby_version %>
    echo "Swithed to ruby `ruby --version`"

    # make sure bundler is installed for that ruby version
    echo "Installing bundler in ruby <%= ruby_version -%>"
    gem install bundler 
    rbenv rehash
    
    cd $PROJECT_DIR
    # install
    <% if !@project_config.install.empty? %>
      <% @project_config.install.each do |test_step| %>
        echo "Running install step '<%= test_step %>'"
        <%= test_step %>
      <% end %>
    <% end %>
    bundle install --without assets production
    rbenv rehash

    cd $PROJECT_DIR
    # before_script
    <% if !@project_config.before_script.empty? %>
      <% @project_config.before_script.each do |step| %>
        echo "Running before_script step '<%= step %>'"
        <%= step %>
      <% end %>
    <% end %>

    T=$(date +%s)
    cd $PROJECT_DIR
    # script
    <% if !@project_config.script.empty? %>
      <% @project_config.script.each do |test_step| %>
        echo "Running script step '<%= test_step %>'"
        <%= test_step %>
      <% end %>
    <% else %>
      echo "Running 'bundle exec rake'"
      bundle exec rake
    <% end %>
    
    # after_success
    # after_failure

    T2=$(date +%s)
    find . -mmin $(((T-T2)/60-1)) -name "*.xml" -exec mv {} $CI_REPORTS \; 

    cd $PROJECT_DIR
    <% if !@project_config.after_script.empty? %>
      <% @project_config.after_script.each do |test_step| %>
        echo "Running after_script step '<%= test_step %>'"
        <%= test_step %>
      <% end %>
    <% end %>
  <% end %>
<% end %>
