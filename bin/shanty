#!/usr/bin/env ruby
$LOAD_PATH.unshift ::File.expand_path(::File.dirname(__FILE__) + '/../lib')

require "thor"
require "shanty"

class ShantyCLI < Thor
  include Thor::Actions

  desc "init <language>", "Initializes Shanty in the present working directory"
  long_desc <<-LONGDESC
    `shanty init <language>` will create a .shanty directory in your user's home
    directory if it doesn't already exist. It will also create a starter
    .shanty.yml in the current working directory if one doesn't already exist.

    Supported Languages: ruby
  LONGDESC
  def init(language)
    initializer = Shanty::Initializer.new
    initializer.init(language)
  end

  desc "build", "Generates Vagrantfile & starter Puppet manifest"
  long_desc <<-LONGDESC
    `shanty build` will create a starting Vagrantfile in the current working
    directory as well as setup a starting puppet manifiest and its tree
    structure.
  LONGDESC
  def build
    builder = Shanty::Builder.new
    builder.build
  end

  desc "test [REVISION]", "Builds a Shanty, runs the tests, then destroys the Shanty"
  long_desc <<-LONGDESC
    `shanty test [--verbose, -v] [REVISION]` Will spin up a new VM using the
    configured provider and run the given test steps against the REVISION.

    REVISION is optional, and if omitted will default to "HEAD".

    Passing the option --verbose will output a lot of debugging information, as
    well as explain exactly which commands are being run. It also enables the
    --verbose and --debug commands for the Vagrantfile, which will give a
    tremendous amount of debugging output.
  LONGDESC
  option :verbose, :type => :boolean, :aliases => "-v"
  def test(revision="HEAD")
    tester = Shanty::Tester.new
    tester.test(options.merge({"revision" => revision}))
  end
end

ShantyCLI.start
